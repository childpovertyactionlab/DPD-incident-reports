---
title: 'null'
author: 'null'
site: bookdown::bookdown_site
output:
  pdf_document: default
  html_document:
    df_print: paged
biblio-style: apalike
link-citations: yes
github-repo: childpovertyactionlab/DPD-incident-reports
favicon: images/favicon.ico
documentclass: book
---

```{r Set-Up Block, include = FALSE}
#### Libraries to load #####
library(tidyverse)
library(sf)
library(leaflet)
library(mapboxapi)
library(lubridate)
library(rio)
library(ggthemes)
library(tidycensus)
library(htmltools)
library(reactable)

#### CPAL theme #####
CPAL.colors = c("#008097", "#ec008c", "#eaca2d", "#b4b4b4", "#9bd9e3", "#fdddd7")

theme_cpal <- function(base_size = 16, base_family = "sans") {
  colors <- deframe(ggthemes::ggthemes_data[["fivethirtyeight"]])
  (theme_foundation(base_size = base_size, base_family = base_family)
    + theme(
      line = element_line(colour = "#b4b4b4"),
      rect = element_rect(fill = "#ffffff",
                          linetype = 1, colour = NA),
      text = element_text(family = "Roboto", face = "bold", colour = "#6c6c6c"),
      axis.title = element_text(),
      axis.title.x = element_text(vjust = 2),
      axis.title.y = element_text(vjust = 2),
      axis.text = element_text(color = "#b4b4b4"),
      axis.ticks = element_blank(),
      #axis.ticks.length = unit(6, "pt"),
      axis.line = element_line(color = "#b4b4b4", size = 1.5, linetype = "solid"),
      legend.background = element_rect(),
      legend.position = "none",
      legend.direction = "horizontal",
      legend.box = "horizontal",
      panel.grid.major = element_line(colour = "#e1e1e1"),
      panel.grid.minor = element_blank(),
      plot.title = element_text(hjust = 0, size = rel(1.5), face = "bold"),
      plot.margin = unit(c(1, 2, 1, 1), "lines"),
      panel.border = element_rect(size=1, fill = NA),
      strip.background = element_rect()
    ))
}

#### Defining vgc and firearms #####
firearm <- c("Handgun", "Rifle","Firearm (Type Not Stated)", "Assault Weapon", "Unknown Type Gun", "Other/Unknown Gun", "Shotgun", "Other Gun", "Other Firearm")
vgc_type <- c("AGG ASSAULT - NFV", "MURDER & NONNEGLIGENT MANSLAUGHTER", "NEGLIGENT MANSLAUGHTER")

#### Importing Dallas Open Data portals and filtering into data frames #####
#dpdIncidents <- import("data/dpd_incidents_groupA.csv") %>%
dpdIncidents <- import("C:/Users/Michael Lopez/Documents/GitHub/dpd_incidents_groupA.csv")
  st_as_sf(coords = c(x = "x_coordinate", y = "y_coordinate"),
                                   crs = "ESRI:102738") %>%
  mutate(Date = as.Date(Date),
         Time = lubridate::hm(Time),
         Year = year(Date),
         Month = month(Date),
         Day = day(Date),
         crime_category = as.factor(nibrs_crime_category),
         crime = as.factor(nibrs_crime),
         Weekday = wday(Date),
         DateTime = format(paste(Date, Time), format="%Y-%m-%d %H:%M:%S"),
         hour = hour(Time),
         vgc_flag = ifelse(nibrs_crime %in% vgc_type & Firearm == 1, 1, 0)) %>%
  select(service_number_id, type_of_incident, type_location, type_of_property, beat:council_district, victim_type, victim_race:victim_age,
         hate_crime, weapon_used, gang_related_offense, zip_code:state, Date:vgc_flag) %>%
  st_transform(crs = 4269)

unique(dpdIncidents$crime)

last30 <- max(dpdIncidents$Date)-days(30)

vgc12months <- dpdIncidents %>%
  filter(vgc_flag == 1,
         Date >= today()-years(1))

vgcIncidents <- dpdIncidents %>%
  filter(vgc_flag == 1,
         Date >= last30)

AggAs <- dpdIncidents %>%
  filter(crime == "AGG ASSAULT - NFV",
         Date >= last30)

RobBus <- dpdIncidents %>%
  filter(crime == "ROBBERY-BUSINESS",
         Date >= last30)

RobInd <- dpdIncidents %>%
  filter(crime == "ROBBERY-INDIVIDUAL",
         Date >= last30)

BurRes <- dpdIncidents %>%
  filter(crime == "BURGLARY-RESIDENCE",
         Date >= last30)

BurBus <- dpdIncidents %>%
  filter(crime == "BURGLARY-BUSINESS",
         Date >= last30)

dpdMini <- dpdIncidents %>%
  filter(crime %in% c("AGG ASSAULT - NFV", "ROBBERY-BUSINESS", "ROBBERY-INDIVIDUAL", "BURGLARY-RESIDENCE", "BURGLARY-BUSINESS"))

#### Import tenth mile grid of the City of Dallas #####
grid_incidents <- st_read("data/dallas_tenthmilegrid.geojson") %>%
  st_transform(crs = 4269) %>%
  mutate(pt_count = lengths(st_intersects(., vgcIncidents)))

#### Import City of Dallas outline #####
#st_layers("E:/CPAL Dropbox/Data Library/Data.gdb")
DallasBoundary <- st_read("E:/CPAL Dropbox/Data Library/Data.gdb", layer = "Dallas_Simple") %>%
  st_transform(crs = 4269)

#### ACS Data #####
#### ACS Data #####
acs_var <- c(
  tot_pop = "B01003_001", #total population
  pop_u18 = "S0101_C01_022", #population under 18
  his_pop = "B03002_012", #hispanic population
  wh_pop = "B03002_003", #white population
  bl_pop = "B03002_004", #black population
  as_pop = "B03002_006", #asian population
#  oohh = "B25106_002", #owner-occupid households
#  rohh = "B25106_024", #renter-occupied households
#  thh = "B25106_001", #total households
  pop_bp = "S1701_C02_001", #population below poverty
  bp_u18 = "S1701_C02_002" #population under 18 below poverty
)

counties <- c("Dallas County",
              "Collin County",
              "Denton County")

tract_demographic_data <- get_acs(
  geography = "tract",
  variables = acs_var,
  year = 2019,
  state = "TX",
  county = counties,
  output = "wide",
  geometry = TRUE) %>%
  mutate(TractArea = as.numeric(st_area(.)))

tract_dallas <- tract_demographic_data[DallasBoundary, ] %>%
  mutate(vgc_count = lengths(st_intersects(., vgc12months)),
         vgc_rate = round(vgc_count/tot_popE*10000, digits = 1))
```

# Dallas Police Department Incident Report {-}
Using data from the Dallas Open Data portal this report is intended to summarize recent Dallas police department incidents. This report is intended to be updated once a month. An important caveat to the data presented within is the exclusion of all incidents involving juveniles. counts are subject to change over time. In order to keep this report manageable it will only include incidents classified as "Group A"

## Notes
* Paragraph with explanation of each table/visualization across sections.
* Quick consistent views of crime in Dallas
* Monthly level
* where are they happening, where are they going down. 
* What are the really big insights/takeaways from this?
* Percent change map 
* Monthly report vs quarterly report vs weekly report
* Generate as a pdf
* Add section on victimization of incidents
* Incorporate at monthly level a section on arrests and section on victims
* What are the typology of where crime exists/concentrated 
* Jacob Kaplan what does he use on his website for rate?
* What other crimes are occurring in places where there is a lot of violent gun crime?
* Cluster analysis with normalization of counts
* Include homicides at top order table by severity
+ homicide, agg assault, robbery, burglary
* Month to month change
* Percent change bar graph year to year
* Calculate crime rate at various intervals one month, one quarter, 12 months
* For final table what are the most common incident types are occurring?
* Include time of day as a categorical factor
+ What types of crimes occur at various time intervals in city
+ Morning, Afternoon, Evening, Late Night, Early Morning
* Victims of vgc, car theft, etc.
* Number of arrests
+ what happened at release?

## Topline {-}
* Are there one or two specific numbers we want to highlight each month as an entry?
```{r, Column Names, echo = FALSE, message=FALSE, warning=FALSE}
names(dpdMini)
```

## Select Group A Incidents Overview {-}
* Currently only includes incidents for the last 30 days of most recent data
* Should be changed to include the most recent full month instead.
* Table can be improved by adding
+ Bars for percent change of Y2Y and Diff5Year variables
+ Addition of title and subtitle
+ Formatting of incident names
+ Use this tutorial to build out framework https://glin.github.io/reactable/articles/building-twitter-followers.html
```{r, Incidents Table, echo = FALSE, message=FALSE, warning=FALSE}
incident_nibrs <- dpdMini %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month, crime) %>%
  summarize(count = n())

incident_vgc <- dpdIncidents %>%
  filter(vgc_flag == 1) %>%
  mutate(crime = "VIOLENT GUN CRIME") %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month, crime) %>%
  summarize(count = n())

incident_table <- full_join(incident_nibrs, incident_vgc) %>%
  filter(Year > 2016)

recent_month <- month(today()-days(14))

report_table <- incident_table %>%
  filter(Month == recent_month) %>%
  ungroup(.) %>%
  select(-Month) %>%
  pivot_wider(names_from = Year,
              names_prefix = "dpd_",
              values_from = count) %>%
  mutate(Year2Year = paste0(round((dpd_2021-dpd_2020)/dpd_2020*100, digits = 1), "%"),
         Avg5Year = (dpd_2017+dpd_2018+dpd_2019+dpd_2020+dpd_2021)/5,
         Diff5Year = paste0(round((dpd_2021-Avg5Year)/Avg5Year*100, digits = 1), "%")) %>%
  select(-(dpd_2017:dpd_2019))

# Render a bar chart with a label on the left
bar_chart <- function(label, width = "100%", height = "14px", fill = "#00bfc4", background = NULL) {
  bar <- div(style = list(background = fill, width = width, height = height))
  chart <- div(style = list(flexGrow = 1, marginLeft = "6px", background = background), bar)
  div(style = list(display = "flex", alignItems = "center"), label, chart)
}

reactable(report_table,
          columns = list(
            crime = colDef(
              name = "NIBRS Incident"),
            dpd_2020 = colDef(
              name = "2020 Incidents"),
            dpd_2021 = colDef(
              name = "2021 Incidents"),
            Year2Year = colDef(
              name = "Percent Change Year to Year"),
            Avg5Year = colDef(
              name = "5 Year Average"),
            Diff5Year = colDef(
              name = "5 Year Average Difference")
            ),
          theme = reactableTheme(
            headerStyle = list(
              "&:hover[aria-sort]" = list(background = "hsl(0, 0%, 96%)"),
              "&[aria-sort='ascending'], &[aria-sort='descending']" = list(background = "hsl(0, 0%, 96%)"),
              borderColor = "#555"
              )
            )
          )
```

## Line Graph of Incidents Over Time

* Change colors of lines to be in line
* Posibly make this interactive with plotly
* Should we have 3 month average instead of total count?
* Change names to be title case
* Include popup of actual value and percent change
* Include by division
* Make bigger
```{r, Incident Line Graph, echo = FALSE, message=FALSE, warning=FALSE}
#### Plot Time Series by Month #####
incident_table %>%
  mutate(YearMonth = as.Date(paste0(Year, "-", Month, "-01"))) %>%
  group_by(crime) %>%
  arrange(YearMonth) %>%
  mutate(Avg3Month = zoo::rollmean(count, k = 3, fill = NA)) %>%
  ungroup(.) %>%
  ggplot(
    aes(
      x = YearMonth,
      y = count,
      group = crime,
      color = crime
    )
  ) +
  geom_line(size=1, alpha = 0.9, stat = "identity") +
  scale_color_manual(values = CPAL.colors) +
  labs(
    title = "Group A Incidents Over Time",
    subtitle = "Between January 2017 - September 2021",
    x = "",
    y = "",
    color = 'VARIABLE'
  ) +
  theme_cpal() +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

## City of Dallas Selected Group A Incidents for September
* Display of selected group A incidents for latest full month.
* Division boundaries as an addition to this map?
* Colors selected for points should be changed. Not all are easily distinctive.
* Should this be a heatmap or cluster map instead?
```{r, fig.height=7, fig.width=7, echo=FALSE, message=FALSE, warning=FALSE}
cpal_style <- "https://api.mapbox.com/styles/v1/owencpal/ckecb71jp22ct19qc1id28jku/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1Ijoib3dlbmNwYWwiLCJhIjoiY2tlYnR3emdxMGNhZzMwb2EzZWR4ajloNCJ9.P7Mujz8F3Rssq5-Q6dcvMw"

map_attr <- "© <a href='https://www.mapbox.com/map-feedback/'>Mapbox</a> Basemap © <a href='https://childpovertyactionlab.org/'>Child Poverty Action Lab</a>"

leaflet() %>%
  setView(lng = -96.7970, lat = 32.7767, zoom = 10) %>%
  addTiles(urlTemplate = cpal_style, attribution = map_attr) %>%
  addCircleMarkers(data = vgcIncidents,
                   stroke = FALSE,
                   radius = 4,
                   fillOpacity = 1,
                   fillColor = "#008097",
                   group = "Violent Gun Crimes") %>%
    addCircleMarkers(data = AggAs,
                   stroke = FALSE,
                   radius = 4,
                   fillOpacity = 1,
                   fillColor = "#ec008c",
                   group = "Aggravated Assault (NFV)") %>%
    addCircleMarkers(data = RobBus,
                   stroke = FALSE,
                   radius = 4,
                   fillOpacity = 1,
                   fillColor = "#eaca2d",
                   group = "Robbery (Business)") %>%
    addCircleMarkers(data = RobInd,
                   stroke = FALSE,
                   radius = 4,
                   fillOpacity = 1,
                   fillColor = "#b4b4b4",
                   group = "Robbery (Individual)") %>%
    addCircleMarkers(data = BurRes,
                   stroke = FALSE,
                   radius = 4,
                   fillOpacity = 1,
                   fillColor = "#9bd9e3",
                   group = "Burglary (Residential)") %>%
    addCircleMarkers(data = BurBus,
                   stroke = FALSE,
                   radius = 4,
                   fillOpacity = 1,
                   fillColor = "#fdddd7",
                   group = "Burglary (Business)") %>%
  addPolygons(data = DallasBoundary,
              fill = FALSE,
              color = "#008097",
              opacity = 1,
              weight = 2) %>%
  addLayersControl(
    overlayGroups = c("Violent Gun Crimes", "Aggravated Assault (NFV)", "Robbery (Business)", "Robbery (Individual)", "Burglary (Residential)", "Burglary (Business)"),
    position = "topright",
    options = layersControlOptions(collapsed = FALSE))
```
## Violent Gun Crime Rate for the past 12 months
* VGC rate calculated for the last 12 months using ACS 2019 data.
* Should this be rate for the most recent full year instead?
* Should rate be calculated using different incident types instead?
* Add popup label to display tract name and actual crime rate for polygon
* May need to clip and calculate total population using summarize within for tracts bordering city limits
* Include other rates for different crime types
```{r, echo = FALSE, message=FALSE, warning=FALSE}
bins <- BAMMtools::getJenksBreaks(tract_dallas$vgc_rate, k = 5)
pal <- colorBin("BuPu", domain = tract_dallas$vgc_rate, bins = bins)

leaflet() %>%
  setView(lng = -96.7970, lat = 32.7767, zoom = 10) %>%
  addTiles(urlTemplate = cpal_style, attribution = map_attr) %>%
  addPolygons(data = tract_dallas,
              fillColor = ~pal(vgc_rate),
              color = FALSE,
              fillOpacity = 0.7,
              opacity = 1,
              weight = 1) %>%
  addPolygons(data = DallasBoundary,
              fill = FALSE,
              color = "#008097",
              opacity = 1,
              weight = 2) %>%
  addLegend(data = tract_dallas, "topleft", pal = pal, values = ~vgc_rate,
            title = "Violent Gun Crime Rate",
            opacity = 1)
```

## Select Group A Incidents by Division
* Currently only includes incidents for the last 30 days of most recent data
* Should be changed to include the most recent full month instead.
* Table can be improved by adding
+ Bars for percent change of Y2Y and Diff5Year variables
+ Addition of title and subtitle
+ Formatting of incident names
+ Use this tutorial to build out framework https://glin.github.io/reactable/articles/building-twitter-followers.html
+ Filter to only include specific divisions or incident type
+ Find way to merge columns based on division column
+ Dig into theming https://glin.github.io/reactable/articles/examples.html#theming
```{r, echo = FALSE, message=FALSE, warning=FALSE}
#names(dpdMini)
incident_nibrs_div <- dpdMini %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month, division, crime) %>%
  summarize(count = n())

incident_vgc_div <- dpdIncidents %>%
  filter(vgc_flag == 1) %>%
  mutate(crime = "VIOLENT GUN CRIME") %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month, division, crime) %>%
  summarize(count = n())

incident_table_div <- full_join(incident_nibrs_div, incident_vgc_div) %>%
  filter(Year > 2016)

recent_month <- month(today()-days(14))

report_table_div <- incident_table_div %>%
  filter(Month == recent_month) %>%
  ungroup(.) %>%
  select(-Month) %>%
  mutate(division = str_to_upper(division)) %>%
  group_by(Year, division, crime) %>%
  summarize(count = sum(count)) %>%
  ungroup(.) %>%
  pivot_wider(names_from = Year,
              names_prefix = "dpd_",
              values_from = count) %>%
  mutate(Year2Year = paste0(round((dpd_2021-dpd_2020)/dpd_2020*100, digits = 1), "%"),
         Avg5Year = (dpd_2017+dpd_2018+dpd_2019+dpd_2020+dpd_2021)/5,
         Diff5Year = paste0(round((dpd_2021-Avg5Year)/Avg5Year*100, digits = 1), "%")) %>%
  select(-(dpd_2017:dpd_2019))

reactable(report_table_div,
          columns = list(
            division = colDef(
              name = "Division Incident"),
            division = colDef(
              name = "NIBRS Incident"),
            dpd_2020 = colDef(
              name = "2020 Incidents"),
            dpd_2021 = colDef(
              name = "2021 Incidents"),
            Year2Year = colDef(
              name = "Percent Change Year to Year"),
            Avg5Year = colDef(
              name = "5 Year Average"),
            Diff5Year = colDef(
              name = "5 Year Average Difference")
            ),
          theme = reactableTheme(
            headerStyle = list(
              "&:hover[aria-sort]" = list(background = "hsl(0, 0%, 96%)"),
              "&[aria-sort='ascending'], &[aria-sort='descending']" = list(background = "hsl(0, 0%, 96%)"),
              borderColor = "#555"
              )
            )
          )
```