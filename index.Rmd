---
title: 'Dallas Police Department Incident Report'
author: 'Child Poverty Action Lab'
site: bookdown::bookdown_site
output:
  pdf_document:
    toc: true
    number_sections: true
#output:
#  pdf_document: default
#  html_document:
#    df_print: paged
always_allow_html: true
biblio-style: apalike
link-citations: yes
github-repo: childpovertyactionlab/DPD-incident-reports
favicon: images/favicon.ico
documentclass: book
---

```{r Set-Up Block, include = FALSE}
#### Libraries to load #####
library(tidyverse)
library(sf)
library(leaflet)
library(mapboxapi)
library(lubridate)
library(rio)
library(tidycensus)
library(htmltools)
library(arcgisbinding)
library(reactable)
library(CPAL)

#### Defining vgc and firearms #####
firearm <- c("Handgun", "Rifle","Firearm (Type Not Stated)", "Assault Weapon", "Unknown Type Gun", "Other/Unknown Gun", "Shotgun", "Other Gun", "Other Firearm")
vgc_type <- c("AGG ASSAULT - NFV", "MURDER & NONNEGLIGENT MANSLAUGHTER", "NEGLIGENT MANSLAUGHTER")

#### Importing Dallas Open Data portals and filtering into data frames #####
dpdIncidents <- import("E:/CPAL Dropbox/Data Library/City of Dallas/04_Public Safety/Dallas Police/Incidents/Incidents by Type/GroupA.csv") %>%
  st_as_sf(coords = c(x = "x_coordinate", y = "y_coordinate"),
                                   crs = "ESRI:102738") %>%
  mutate(Date = as.Date(Date),
         Time = lubridate::hm(Time),
         Year = year(Date),
         Month = month(Date),
         Day = day(Date),
         division = str_to_title(division),
         crime_category = as.factor(nibrs_crime_category),
         crime = as.factor(nibrs_crime),
         Weekday = wday(Date),
         DateTime = format(paste(Date, Time), format="%Y-%m-%d %H:%M:%S"),
         hour = hour(Time),
         vgc_flag = ifelse(nibrs_crime %in% vgc_type & Firearm == 1, 1, 0)) %>%
  select(service_number_id, type_of_incident, type_location, type_of_property, beat:council_district, victim_type:victim_gender, hate_crime, weapon_used, gang_related_offense, zip_code:state, Date:vgc_flag, tot_victims) %>%
  st_transform(crs = 4269)

#unique(dpdIncidents$crime)

currentmonth <- as.Date(paste0(year(today()), "-", month(today()), "-01"))

last30 <- as.Date(paste0(year(today()), "-", month(max(dpdIncidents$Date)), "-01"))

vgc5year <- dpdIncidents %>%
  filter(vgc_flag == 1,
         Date >= as.Date("2016-01-01"))

vgc12months <- dpdIncidents %>%
  filter(vgc_flag == 1,
         Date >= as.Date("2021-01-01"))

vgc30days <- dpdIncidents %>%
  filter(vgc_flag == 1,
         Date >= last30 & Date < currentmonth)

AggAs <- dpdIncidents %>%
  filter(crime == "AGG ASSAULT - NFV",
         Date >= last30 & Date < currentmonth)

RobBus <- dpdIncidents %>%
  filter(crime == "ROBBERY-BUSINESS",
         Date >= last30 & Date < currentmonth)

RobInd <- dpdIncidents %>%
  filter(crime == "ROBBERY-INDIVIDUAL",
         Date >= last30 & Date < currentmonth)

BurRes <- dpdIncidents %>%
  filter(crime == "BURGLARY-RESIDENCE",
         Date >= last30 & Date < currentmonth)

BurBus <- dpdIncidents %>%
  filter(crime == "BURGLARY-BUSINESS",
         Date >= last30 & Date < currentmonth)

dpdMini <- dpdIncidents %>%
  filter(crime %in% c("AGG ASSAULT - NFV", "ROBBERY-BUSINESS", "ROBBERY-INDIVIDUAL", "BURGLARY-RESIDENCE", "BURGLARY-BUSINESS", "MURDER & NONNEGLIGENT MANSLAUGHTER")) %>%
  filter(Date >= last30 & Date < currentmonth)

#### Import tenth mile grid of the City of Dallas #####
grid_incidents <- st_read("data/dallas_tenthmilegrid.geojson") %>%
  st_transform(crs = 4269) %>%
  mutate(vgc_5year = lengths(st_intersects(., vgc5year)),
         vgc_12months = lengths(st_intersects(., vgc12months)),
         vgc_5yearAvg = vgc_5year/5,
         vgc_perch = (vgc_12months-vgc_5yearAvg)/vgc_5yearAvg)

#### Import  Dallas boundaries #####
DallasBoundary <- st_read("data/dallas_simpleboundary.geojson") %>%
  st_transform(crs = 4269)

dpd_beats <- st_read("data/dpd_beats.geojson") %>%
  st_transform(crs = 4269)

dpd_divisions <- st_read("data/dpd_divisions.geojson") %>%
  st_transform(crs = 4269)

#### ACS Data #####
acs_var <- c(
  tot_pop = "B01003_001", #total population
  pop_u18 = "S0101_C01_022", #population under 18
  his_pop = "B03002_012", #hispanic population
  wh_pop = "B03002_003", #white population
  bl_pop = "B03002_004", #black population
  as_pop = "B03002_006", #asian population
#  oohh = "B25106_002", #owner-occupid households
#  rohh = "B25106_024", #renter-occupied households
#  thh = "B25106_001", #total households
  pop_bp = "S1701_C02_001", #population below poverty
  bp_u18 = "S1701_C02_002" #population under 18 below poverty
)

counties <- c("Dallas County",
              "Collin County",
              "Denton County")

tract_demographic_data <- get_acs(
  geography = "tract",
  variables = acs_var,
  year = 2019,
  state = "TX",
  county = counties,
  output = "wide",
  geometry = TRUE) %>%
  mutate(TractArea = as.numeric(st_area(.)))

tract_dallas <- tract_demographic_data[DallasBoundary, ] %>%
  mutate(vgc_count = lengths(st_intersects(., vgc12months)),
         vgc_rate = round(vgc_count/tot_popE*10000, digits = 1))

incident_comp <- dpdIncidents %>%
    filter(crime %in% c("AGG ASSAULT - NFV", "MURDER & NONNEGLIGENT MANSLAUGHTER") & Firearm == 1) %>%
  filter((Year == 2021 & Month == month(last30)) |
           (Year == 2020 & Month == month(last30)) |
           (Year == 2021 & Month == month(last30)-month(1))) %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month) %>%
  summarise(count = n())

incident_01 <- incident_comp %>%
  filter(Year == 2021 & Month == month(last30))

incident_02 <- incident_comp %>%
  filter(Year == 2021 & Month == month(last30)-month(1))

incident_03 <- incident_comp %>%
  filter(Year == 2020 & Month == month(last30))

incident_04 <- dpdIncidents %>%
    filter(crime %in% c("AGG ASSAULT - NFV", "ROBBERY-BUSINESS", "ROBBERY-INDIVIDUAL", "BURGLARY-RESIDENCE", "BURGLARY-BUSINESS", "MURDER & NONNEGLIGENT MANSLAUGHTER")) %>%
  filter((Year == 2021 & Month == month(last30))) %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month) %>%
  summarise(count = n())
```

```{r, High Risk Cells, include = FALSE}
#### Import High Risk RTM Cells from most recent models
st_layers("E:/CPAL Dropbox/Safe Surroundings/04_Projects/RTM 2021/2021_Q3_RTM/Data/RTM_Q32021_Outputs.gpkg")

SE_HR <- st_read("E:/CPAL Dropbox/Safe Surroundings/04_Projects/RTM 2021/2021_Q3_RTM/Data/RTM_Q32021_Outputs.gpkg", layer = "SE_HighRisk") %>%
  st_transform(crs = 4269)
SC_HR <- st_read("E:/CPAL Dropbox/Safe Surroundings/04_Projects/RTM 2021/2021_Q3_RTM/Data/RTM_Q32021_Outputs.gpkg", layer = "SC_HighRisk") %>%
  st_transform(crs = 4269)
C_HR <- st_read("E:/CPAL Dropbox/Safe Surroundings/04_Projects/RTM 2021/2021_Q3_RTM/Data/RTM_Q32021_Outputs.gpkg", layer = "C_HighRisk") %>%
  st_transform(crs = 4269)
NC_HR <- st_read("E:/CPAL Dropbox/Safe Surroundings/04_Projects/RTM 2021/2021_Q3_RTM/Data/RTM_Q32021_Outputs.gpkg", layer = "NC_HighRisk") %>%
  st_transform(crs = 4269)
NE_HR <- st_read("E:/CPAL Dropbox/Safe Surroundings/04_Projects/RTM 2021/2021_Q3_RTM/Data/RTM_Q32021_Outputs.gpkg", layer = "NE_HighRisk") %>%
  st_transform(crs = 4269)
NW_HR <- st_read("E:/CPAL Dropbox/Safe Surroundings/04_Projects/RTM 2021/2021_Q3_RTM/Data/RTM_Q32021_Outputs.gpkg", layer = "NW_HighRisk") %>%
  st_transform(crs = 4269)
SW_HR <- st_read("E:/CPAL Dropbox/Safe Surroundings/04_Projects/RTM 2021/2021_Q3_RTM/Data/RTM_Q32021_Outputs.gpkg", layer = "SW_HighRisk") %>%
  st_transform(crs = 4269)

unique(dpdMini$division)

SC_Mark <- dpdMini %>%
  filter(division == "South Central") %>%
  .[SC_HR, ] %>%
  mutate(HighRisk = "TRUE") %>%
  st_drop_geometry(.) %>%
  select(service_number_id, HighRisk)

SE_Mark <- dpdMini %>%
  filter(division == "Southeast") %>%
  .[SE_HR, ] %>%
  mutate(HighRisk = "TRUE") %>%
  st_drop_geometry(.) %>%
  select(service_number_id, HighRisk)

NE_Mark <- dpdMini %>%
  filter(division == "Northeast") %>%
  .[NE_HR, ] %>%
  mutate(HighRisk = "TRUE") %>%
  st_drop_geometry(.) %>%
  select(service_number_id, HighRisk)

NW_Mark <- dpdMini %>%
  filter(division == "Northwest") %>%
  .[NW_HR, ] %>%
  mutate(HighRisk = "TRUE") %>%
  st_drop_geometry(.) %>%
  select(service_number_id, HighRisk)

C_Mark <- dpdMini %>%
  filter(division == "Central") %>%
  .[C_HR, ] %>%
  mutate(HighRisk = "TRUE") %>%
  st_drop_geometry(.) %>%
  select(service_number_id, HighRisk)

SW_Mark <- dpdMini %>%
  filter(division == "Southwest") %>%
  .[SW_HR, ] %>%
  mutate(HighRisk = "TRUE") %>%
  st_drop_geometry(.) %>%
  select(service_number_id, HighRisk)

NC_Mark <- dpdMini %>%
  filter(division == "North Central") %>%
  .[NC_HR, ] %>%
  mutate(HighRisk = "TRUE") %>%
  st_drop_geometry(.) %>%
  select(service_number_id, HighRisk)

dpdMini <- bind_rows(SC_Mark, SE_Mark, NE_Mark, NW_Mark, C_Mark, SW_Mark, NC_Mark) %>%
  left_join(dpdMini, .)

rm(SC_Mark)
rm(SE_Mark)
rm(SW_Mark)
rm(C_Mark)
rm(NC_Mark)
rm(NE_Mark)
rm(NW_Mark)

rm(SC_HR)
rm(SE_HR)
rm(SW_HR)
rm(C_HR)
rm(NC_HR)
rm(NE_HR)
rm(NW_HR)

month_01 <- as.character(month(last30, abbr = FALSE, label = TRUE))
month_02 <- as.character(month(last30 %m-% months(1), abbr = FALSE, label = TRUE))
year_01 <- as.character(year(last30))
year_02 <- as.character(year(last30-years(1)))
```

# Report Framing
Using data from the Dallas Open Data portal this report is intended to summarize police incidents in the City of Dallas on a monthly basis.

Incident records from the Dallas Open Data portal currently exclude certain incident types (such as incidents involving juveniles) and may be subject to change over time.

In order to keep this report concise only a select number of incidents classified as "Group A" will be included.

```{r, Incident Defitions, echo = FALSE, message=FALSE, warning=FALSE, fig.width=12,fig.height=8}
order <- c(1, 2, 3, 4, 5, 6, 7)

nibrs <- c("Murder & Non-negligent Manslaughter", 
           "Violent Gun Crime", 
           "Aggravated Assault (NFV)", 
           "Robbery (Individual)", 
           "Robbery (Business)", 
           "Burglary (Residence)", 
           "Burglary (Business)") 

definition <- c("The willful (non-negligent) killing of one human being by another.", 
                "A violent Group A that occurs with the use of a firearm. Includes aggravated assault, murder and non-negligent manslaughter, robbery, and burglary,",
                "An unlawful attack by one person upon another for the purpose of inflicting severe or aggravated bodily injury.",
                "The taking or attempt to take anything of value from an individual by force, threat of force or violence.",
                "The taking or attempt to take anything of value from an business by force, threat of force or violence.",
                "The unlawful entry of a residence to commit a felony or a theft.",
                "The unlawful entry of a business to commit a felony or a theft.")

incident_def <- data.frame(order, nibrs, definition)

tbl_incidents <- reactable(incident_def,
          compact = TRUE,
          class = "cpal-tbl",
          defaultSorted = c("order"),
          columns = list(
            order = colDef(
              name = "Order",
              show = FALSE),
            nibrs = colDef(
              name = "NIBRS Incident"),
            definition = colDef(
              name = "Definition")
            ))

div(class = "cpal-table",
  div(class = "cpal-header",
    h2(class = "cpal-title", "Incidents Included in Report")),
  tbl_incidents
)
```

The reported U.S. violent crime rate includes murder, rape and sexual assault, robbery, and assault

# City of Dallas Overview

## Main Takeaways {-}

The violent crime rate for `r paste(month_01, year_01)` was `r round(incident_01$count/(1304379/10000), digits = 3)` per 10,000 residents.

In the month of `r paste(month_01, year_01)` there was a total of `r incident_01$count` violent gun crimes across the city. 

This is an `r ifelse(incident_01$count > incident_02$count, "increase", "decrease")` of `r paste0(round(((incident_01$count-incident_02$count)/incident_02$count)*100, digits = 1), "%")` from `r paste(month_02, year_01)`, and an `r ifelse(incident_01$count > incident_03$count, "increase", "decrease")` of `r paste0(round(((incident_01$count-incident_03$count)/incident_03$count)*100, digits = 1), "%")` from `r paste(month_01, year_02)`.

There were **##** incidents with 4 or more victims across the city.

**Z%** of all violent gun crimes in October occurred in **DivisionX**  

## Select Group A Incidents Overview {-}

The table below contains an overview of selected group A incidents for the most recent complete month (September). Data focuses on the count of incidents within the full month compared to the same month for the previous year and a three year average for the specified month. 

```{r, Incidents Table, echo = FALSE, message=FALSE, warning=FALSE, fig.width=12,fig.height=8}
incident_nibrs <- dpdIncidents %>%
  filter(crime %in% c("AGG ASSAULT - NFV", "ROBBERY-BUSINESS", "ROBBERY-INDIVIDUAL", "BURGLARY-RESIDENCE", "BURGLARY-BUSINESS", "MURDER & NONNEGLIGENT MANSLAUGHTER")) %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month, crime) %>%
  summarize(count = n())

incident_vgc <- dpdIncidents %>%
  filter(vgc_flag == 1 & crime %in% vgc_type) %>%
  mutate(crime = "VIOLENT GUN CRIME") %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month, crime) %>%
  summarize(count = n())

incident_table <- full_join(incident_nibrs, incident_vgc) %>%
  filter(Year > 2016) %>%
  mutate(crime_title = ifelse(crime == "MURDER & NONNEGLIGENT MANSLAUGHTER", "Murder & Nonnegligent Manslaughter",
                              ifelse(crime == "VIOLENT GUN CRIME", "Violent Gun Crime",
                                     ifelse(crime == "AGG ASSAULT - NFV", "Aggravated Assault (NFV)",
                                            ifelse(crime == "ROBBERY-BUSINESS", "Robbery (Business)",
                                                   ifelse(crime == "ROBBERY-INDIVIDUAL", "Robbery (Individual)",
                                                          ifelse(crime == "BURGLARY-RESIDENCE", "Burglary (Residence)",
                                                                 ifelse(crime == "BURGLARY-BUSINESS", "Burglary (Business)",
                                                                        "ERROR"
                              ))))))))

recent_month <- month(today())-month(1)

report_table <- incident_table %>%
  filter(Month == recent_month) %>%
  ungroup(.) %>%
  select(-Month) %>%
  pivot_wider(names_from = Year,
              names_prefix = "dpd_",
              values_from = count) %>%
  mutate(Year2Year = round((dpd_2021-dpd_2020)/dpd_2020, digits = 3),
         Avg3Year = round((dpd_2019+dpd_2020+dpd_2021)/3, digits = 3),
         Diff3Year = round((dpd_2021-Avg3Year)/Avg3Year, digits = 3),
         crime = factor(crime, levels = c("MURDER & NONNEGLIGENT MANSLAUGHTER", "VIOLENT GUN CRIME", "AGG ASSAULT - NFV", "ROBBERY-BUSINESS", "ROBBERY-INDIVIDUAL", "BURGLARY-RESIDENCE", "BURGLARY-BUSINESS")),
         crime_title = ifelse(crime == "MURDER & NONNEGLIGENT MANSLAUGHTER", "Murder & Nonnegligent Manslaughter",
                              ifelse(crime == "VIOLENT GUN CRIME", "Violent Gun Crime",
                                     ifelse(crime == "AGG ASSAULT - NFV", "Aggravated Assault (NFV)",
                                            ifelse(crime == "ROBBERY-BUSINESS", "Robbery (Business)",
                                                   ifelse(crime == "ROBBERY-INDIVIDUAL", "Robbery (Individual)",
                                                          ifelse(crime == "BURGLARY-RESIDENCE", "Burglary (Residence)",
                                                                 ifelse(crime == "BURGLARY-BUSINESS", "Burglary (Business)",
                                                                        "ERROR"
                              ))))))),
         crime_order = ifelse(crime == "MURDER & NONNEGLIGENT MANSLAUGHTER", 1,
                              ifelse(crime == "VIOLENT GUN CRIME", 2,
                                     ifelse(crime == "AGG ASSAULT - NFV", 3,
                                            ifelse(crime == "ROBBERY-BUSINESS", 4,
                                                   ifelse(crime == "ROBBERY-INDIVIDUAL", 5,
                                                          ifelse(crime == "BURGLARY-RESIDENCE", 6,
                                                                 ifelse(crime == "BURGLARY-BUSINESS", 7,
                                                                        "ERROR"
                              ))))))))%>%
  select(-(dpd_2017:dpd_2019), -crime) %>%
  relocate(crime_order, crime_title, dpd_2020, dpd_2021, Year2Year, Avg3Year, Diff3Year)

# Render a bar chart with a label on the left
#####
bar_chart_pos_neg <- function(label, value, max_value = 1, height = "16px",
                              pos_fill = "#008097", neg_fill = "#ec008c") {
  neg_chart <- div(style = list(flex = "1 1 0"))
  pos_chart <- div(style = list(flex = "1 1 0"))
  width <- paste0(abs(value / max_value) * 100, "%")

  if (value < 0) {
    bar <- div(style = list(marginLeft = "8px", background = neg_fill, width = width, height = height))
    chart <- div(style = list(display = "flex", alignItems = "center", justifyContent = "flex-end"), label, bar)
    neg_chart <- tagAppendChild(neg_chart, chart)
  } else {
    bar <- div(style = list(marginRight = "8px", background = pos_fill, width = width, height = height))
    chart <- div(style = list(display = "flex", alignItems = "center"), bar, label)
    pos_chart <- tagAppendChild(pos_chart, chart)
  }

  div(style = list(display = "flex"), neg_chart, pos_chart)
}

#####
tbl_incidents <- reactable(report_table,
          compact = TRUE,
          class = "cpal-tbl",
          defaultSorted = c("crime_order"),
          columns = list(
            crime_order = colDef(
              name = "Order",
              show = FALSE),
            crime_title = colDef(
              name = "NIBRS"),
            dpd_2020 = colDef(
              name = "2020"),
            dpd_2021 = colDef(
              name = "2021"),
            Year2Year = colDef(
              name = "One Year",
              defaultSortOrder = "desc",
              cell = function(value) {
                label <- paste0(format(value*100, nsmall = 1), "%")
                bar_chart_pos_neg(label, value)
              },
              align = "center"
              ),
            Avg3Year = colDef(
              name = "Three Year",
              defaultSortOrder = "desc"),
            Diff3Year = colDef(
              name = "Three Years",
              defaultSortOrder = "desc",
              cell = function(value) {
                label <- paste0(format(value*100, nsmall = 1), "%")
                bar_chart_pos_neg(label, value)
              },
              align = "center"
              )
            ),
          columnGroups = list(
            colGroup(name = paste(month(last30, label = TRUE, abbr = FALSE), "Incidents"), columns = c("dpd_2020", "dpd_2021")),
            colGroup(name = "Percent Change", columns = c("Year2Year", "Diff3Year")),
            colGroup(name = "Average", columns = c("Avg3Year"))
          )
            )

div(class = "cpal-table",
  div(class = "cpal-header",
    h2(class = "cpal-title", "Selected Group A Incidents for September 2021"),
    "Incidents compared to averages of incident data since 2019"
  ),
  tbl_incidents
)
```

# Incidents by Time

## Count of Incidents by Year {-}

```{r, Incident Line Graph, echo = FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=8}
#### Plot Time Series by Month #####
incident_table %>%
  mutate(YearMonth = as.Date(paste0(Year, "-", Month, "-01"))) %>%
  group_by(crime_title) %>%
  arrange(YearMonth) %>%
  mutate(Avg3Month = zoo::rollmean(count, k = 3, fill = NA)) %>%
  ungroup(.) %>%
  ggplot(
    aes(
      x = YearMonth,
      y = count,
      group = crime_title,
      color = crime_title
    )
  ) +
  geom_line(size=1, alpha = 0.9, stat = "identity") +
  scale_color_manual(values = cpal_palette(n=10, name = "cpal_ten")) +
  labs(
    title = "Select Group A Incidents Over Time",
    subtitle = paste("Between January 2017 -", month(last30, label = TRUE, abbr = FALSE), year(last30)),
    x = "",
    y = "",
    color = 'VARIABLE'
  ) +
  theme_cpal(base_size = 28) +
  theme(legend.text=element_text(size=14))
```

## Average Incidents by Time of Day {-}

For the month of October
**X%** of incidents across the city occurred between **HH:MM:** and **HH:MM:**
**Y%** of incidents across the city occurred between **HH:MM:** and **HH:MM:**

## Incidents by Time Period {-}

Facet wrap pie charts of incident types grouped by time of day (early morning, morning, afternoon, evening, late night) 

# Incidents Across Geography
The reported U.S. violent crime rate includes murder, rape and sexual assault, robbery, and assault.

## Violent Crime Rate {-}

This map displays the violent crime rate (per 10,000 residents) for the past 12 months by census tract. 

```{r, Violent Crime Rate Map, echo = FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=6}
cpal_style <- "https://api.mapbox.com/styles/v1/owencpal/ckecb71jp22ct19qc1id28jku/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1Ijoib3dlbmNwYWwiLCJhIjoiY2tlYnR3emdxMGNhZzMwb2EzZWR4ajloNCJ9.P7Mujz8F3Rssq5-Q6dcvMw"

map_attr <- "© <a href='https://www.mapbox.com/map-feedback/'>Mapbox</a> Basemap © <a href='https://childpovertyactionlab.org/'>Child Poverty Action Lab</a>"

bins <- BAMMtools::getJenksBreaks(tract_dallas$vgc_rate, k = 5)
pal <- colorBin("BuPu", domain = tract_dallas$vgc_rate, bins = bins)

leaflet() %>%
  setView(lng = -96.7970, lat = 32.7767, zoom = 10) %>%
  addTiles(urlTemplate = cpal_style, attribution = map_attr) %>%
  addPolygons(data = tract_dallas,
              fillColor = ~pal(vgc_rate),
              color = FALSE,
              fillOpacity = 0.7,
              opacity = 1,
              weight = 1,
              label = ~paste("VGC Rate:", vgc_rate)) %>%
  addPolygons(data = dpd_divisions,
              fill = FALSE,
              color = "#008097",
              opacity = 1,
              weight = 2) %>%
  addLegend(data = tract_dallas, "topleft", pal = pal, values = ~vgc_rate,
            title = "Violent Crime Rate",
            opacity = 1)
```

## Change in Violent Crime {-}

This map displays the average percent change in violent crimes for the past 12 months in comparison to an average of incidents over the last 5 years. All incidents are aggregated to a tenth mile width grid.

```{r, fig.height=7, fig.width=7, echo=FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=6}
cpal_style <- "https://api.mapbox.com/styles/v1/owencpal/ckecb71jp22ct19qc1id28jku/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1Ijoib3dlbmNwYWwiLCJhIjoiY2tlYnR3emdxMGNhZzMwb2EzZWR4ajloNCJ9.P7Mujz8F3Rssq5-Q6dcvMw"

map_attr <- "© <a href='https://www.mapbox.com/map-feedback/'>Mapbox</a> Basemap © <a href='https://childpovertyactionlab.org/'>Child Poverty Action Lab</a>"

vgc_grid <- grid_incidents %>%
  filter(!is.na(vgc_perch))

absVal <- max(abs(vgc_grid$vgc_perch))
domain <- c((absVal*-1),absVal)

colorPal <- c(colorRampPalette(colors = c("#008097", "white"), space = "Lab")(abs(absVal)),
              colorRampPalette(colors = c("white", "#E98816"), space = "Lab")(absVal))

leaflet() %>%
  setView(lng = -96.7970, lat = 32.7767, zoom = 10) %>%
  addTiles(urlTemplate = cpal_style, attribution = map_attr) %>%
  addPolygons(data = vgc_grid,
              fillColor = ~get('colorBin')(colorPal,
                                           domain)(vgc_perch),
              label = ~paste0(round(vgc_perch*100, digits = 2), "%"),
              color = FALSE,
              fillOpacity = 0.7,
              opacity = 1,
              weight = 1,
              group = "Violent Gun Crimes")  %>%
    addPolygons(data = dpd_divisions,
              fill = FALSE,
              color = "#008097",
              opacity = 1,
              weight = 2) %>%
  addLegend(data = vgc_grid, 
            "topleft", 
            pal = colorBin(colorPal, domain = domain),
            values = ~domain,
            title = "VGC Percent Change (5 Year)",
            opacity = 0.9)
```

# Typology of Incidents

## Incidents by Location of Incident {-}

```{r, echo = FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=8}
dpdMini %>%
  st_drop_geometry(.) %>%
  filter(Date >= as.Date("2021-09-01") & Date < as.Date("2021-10-01")) %>%  
  group_by(type_location) %>%
  summarize(victim_count = n()) %>%
  arrange(desc(victim_count)) %>%
  mutate(perc = victim_count/sum(victim_count)) %>%
  slice_head(., n = 7) %>%
  ggplot(
    aes(
      x = type_location,
      y = victim_count,
      #      group = crime_category,
      #      color = victim_race,
      fill = type_location,
    )
  ) +
  geom_bar(size=1, alpha = 1, stat = "identity") +
  #  scale_color_manual(values = CPAL.color.eight) +
  scale_fill_manual(values = cpal_palette(n=10, name = "cpal_ten")) +
  geom_text(aes(label = scales::percent(perc, accuracy = 0.1)),
            vjust = 2, color = "#FFFFFF", fontface = "bold", size = 7) +
  #  scale_size_manual(values = 3) +
  #  theme(legend.position = "none") +
  labs(
    title = "Violent Gun Crime by Premise",
    subtitle = paste("For the month of", month(last30, label = TRUE, abbr = FALSE), year(last30)),
    x = "",
    y = "",
    color = 'VARIABLE'
  ) +
  theme_cpal(base_size = 28) +
  theme(axis.text.x=element_text(angle=30, hjust=0.7, vjust = 0.7),
        legend.position = "none")

```

## Incidents Within Multi-Family Residences {-}

Table or bar chart describing the most common types of incidents within multi-family premises (include parking lots, buildings, etc)

## Incidents Within Single-Family Residences {-}

Table or bar chart describing the most common types of incidents within single-family premises (include occupied, unoccupied, etc)

## Incidents Within Commercial Businesses {-}

Table or bar chart describing the most common types of incidents within commercial premises (include parking lots, tabc location, occupied/vacant, etc)

# Incident Victims

## Incidents by Race of Victim {-}

```{r, echo = FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=8}
plot.demo <- as_tibble(cbind(victim_race = c("American Indian or Alaska Native", "Asian","Black", "Hispanic or Latino", "White"),
                             type = c("City", "City", "City", "City", "City"),
                             per = c(0.014, 0.0336, 0.2395, 0.4180, 0.2897))) %>%
  #per = c(0, 0, 0.56, 0.32, 0.02))) %>% #SC Quadrant
  mutate(per = as.double(per))

plot.vgc <- dpdMini %>%
  st_drop_geometry(.) %>%
  filter(Date >= as.Date("2021-09-01") & Date < as.Date("2021-10-01")) %>%
  drop_na(victim_race) %>%
  group_by(victim_race) %>%
  summarize(victim_count = n()) %>%
  mutate(type = "Incident Victims",
         per = victim_count/sum(victim_count)) %>% #EDIT FOR OTHER GEOGRAPHIES
  filter(victim_race != "Unknown",
         victim_race != "NH",
         victim_race != "Native Hawaiian/Pacific Islander",
         #victim_race != "American Indian or Alaska Native",
         victim_race != "Middle Eastern",
         victim_race != "")

plot.race <- full_join(plot.demo, plot.vgc) %>%
  mutate(type = as.factor(type)) %>%
  filter(per != 0)

plot.race %>%
  ggplot(
    aes(
      x = victim_race,
      y = per,
      fill = type
    )
  ) +
  geom_bar(size=1, alpha = 1, stat = 'identity', position = 'dodge') +
  scale_y_continuous(labels = scales::percent, limits = c(0,0.6)) +
  scale_fill_manual(values = cpal_palette(n = 2, "cpal_two")) +
  theme_cpal(base_size = 28) +
  theme(legend.position = "bottom",
        legend.title=element_blank()) +
  labs(
    title = "Incident Victims by selected incident types",
    subtitle = "In comparison to city demographics (%).",
    x = "",
    y = "",
    color = ""
  )

```

# Incident Arrests 

## Clearance Rate {-}

## Incidents by arrests {-}

# Division

## Select Group A Incidents by Division {-}

```{r, echo = FALSE, message=FALSE, warning=FALSE, fig.width=12,fig.height=8}
incident_nibrs_div <- dpdMini %>%
  mutate(division = str_to_title(division)) %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month, division, crime) %>%
  summarize(count = n())

incident_vgc_div <- dpdIncidents %>%
  mutate(division = str_to_title(division)) %>%
  filter(vgc_flag == 1) %>%
  mutate(crime = "VIOLENT GUN CRIME") %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month, division, crime) %>%
  summarize(count = n())

incident_table_div <- full_join(incident_nibrs_div, incident_vgc_div) %>%
  filter(Year > 2016) %>%
  mutate(crime_title = ifelse(crime == "MURDER & NONNEGLIGENT MANSLAUGHTER", "Murder & Nonnegligent Manslaughter",
                              ifelse(crime == "VIOLENT GUN CRIME", "Violent Gun Crime",
                                     ifelse(crime == "AGG ASSAULT - NFV", "Aggravated Assault (NFV)",
                                            ifelse(crime == "ROBBERY-BUSINESS", "Robbery (Business)",
                                                   ifelse(crime == "ROBBERY-INDIVIDUAL", "Robbery (Individual)",
                                                          ifelse(crime == "BURGLARY-RESIDENCE", "Burglary (Residence)",
                                                                 ifelse(crime == "BURGLARY-BUSINESS", "Burglary (Business)",
                                                                        "ERROR"
                              ))))))))

report_table_div <- incident_table_div %>%
  filter(Month == recent_month) %>%
  ungroup(.) %>%
  select(-Month) %>%
  pivot_wider(names_from = Year,
              names_prefix = "dpd_",
              values_from = count) %>%
  mutate(dpd_2021 = ifelse(is.na(dpd_2021), 0, dpd_2021), 
         dpd_2020 = ifelse(is.na(dpd_2020), 0, dpd_2020),
         dpd_2019 = ifelse(is.na(dpd_2019), 0, dpd_2019),
         Year2Year = round((dpd_2021-dpd_2020)/dpd_2020, digits = 3),
         Avg3Year = round((dpd_2019+dpd_2020+dpd_2021)/3, digits = 3),
         Diff3Year = round((dpd_2021-Avg3Year)/Avg3Year, digits = 3),
         crime = factor(crime, levels = c("MURDER & NONNEGLIGENT MANSLAUGHTER", "VIOLENT GUN CRIME", "AGG ASSAULT - NFV", "ROBBERY-BUSINESS", "ROBBERY-INDIVIDUAL", "BURGLARY-RESIDENCE", "BURGLARY-BUSINESS")),
         crime_title = ifelse(crime == "MURDER & NONNEGLIGENT MANSLAUGHTER", "Murder & Nonnegligent Manslaughter",
                              ifelse(crime == "VIOLENT GUN CRIME", "Violent Gun Crime",
                                     ifelse(crime == "AGG ASSAULT - NFV", "Aggravated Assault (NFV)",
                                            ifelse(crime == "ROBBERY-BUSINESS", "Robbery (Business)",
                                                   ifelse(crime == "ROBBERY-INDIVIDUAL", "Robbery (Individual)",
                                                          ifelse(crime == "BURGLARY-RESIDENCE", "Burglary (Residence)",
                                                                 ifelse(crime == "BURGLARY-BUSINESS", "Burglary (Business)",
                                                                        "ERROR"
                              ))))))),
         crime_order = ifelse(crime == "MURDER & NONNEGLIGENT MANSLAUGHTER", 1,
                              ifelse(crime == "VIOLENT GUN CRIME", 2,
                                     ifelse(crime == "AGG ASSAULT - NFV", 3,
                                            ifelse(crime == "ROBBERY-BUSINESS", 4,
                                                   ifelse(crime == "ROBBERY-INDIVIDUAL", 5,
                                                          ifelse(crime == "BURGLARY-RESIDENCE", 6,
                                                                 ifelse(crime == "BURGLARY-BUSINESS", 7,
                                                                        "ERROR"
                              ))))))))%>%
  select(-(dpd_2017:dpd_2019), -crime) %>%
  relocate(division, crime_order, crime_title, dpd_2020, dpd_2021, Year2Year, Avg3Year, Diff3Year)

#####
tbl_incidents_div <- reactable(report_table_div,
          compact = TRUE,
          class = "cpal-tbl",
          groupBy = "division",
          defaultSorted = c("crime_order"),
          columns = list(
            division = colDef(
              name = "Division"),
            crime_order = colDef(
              name = "Order",
              show = FALSE),
            crime_title = colDef(
              name = "NIBRS"),
            dpd_2020 = colDef(
              name = "2020",
              na = "-"),
            dpd_2021 = colDef(
              name = "2021",
              na = "-"),
            Year2Year = colDef(
              name = "One Year",
              na = "-",
              cell = function(value) {
                label <- paste0(format(value*100, nsmall = 1), "%")
                bar_chart_pos_neg(label, value)
              },
              align = "center"
              ),
            Avg3Year = colDef(
              name = "Three Year",
              na = "-"),
            Diff3Year = colDef(
              name = "Three Years",
              na = "-",
              cell = function(value) {
                label <- paste0(format(value*100, nsmall = 1), "%")
                bar_chart_pos_neg(label, value)
              },
              align = "center"
              )
            ),
          columnGroups = list(
            colGroup(name = paste(month(last30, label = TRUE, abbr = FALSE), "Incidents"), columns = c("dpd_2020", "dpd_2021")),
            colGroup(name = "Percent Change", columns = c("Year2Year", "Diff3Year")),
            colGroup(name = "Average", columns = c("Avg3Year"))
          )
            )

div(class = "cpal-table",
  div(class = "cpal-header",
    h2(class = "cpal-title", paste("Selected Group A Incidents for", month(last30, label = TRUE, abbr = FALSE), year(last30))),
    "Incidents compared to averages of incident data since 2019"
  ),
  tbl_incidents_div
)
```


