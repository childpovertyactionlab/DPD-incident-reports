---
title: 'null'
author: 'null'
site: bookdown::bookdown_site
output:
  pdf_document: default
  html_document:
    df_print: paged
biblio-style: apalike
link-citations: yes
github-repo: childpovertyactionlab/DPD-incident-reports
favicon: images/favicon.ico
documentclass: book
---

```{r Set-Up Block, include = FALSE}
#### Libraries to load #####
library(tidyverse)
library(sf)
library(leaflet)
library(mapboxapi)
library(lubridate)
library(rio)
library(ggthemes)
library(tidycensus)
library(htmltools)
library(arcgisbinding)
library(reactable)

#### CPAL theme #####
CPAL.colors = c("#008097", "#e98816", "#ec008c", "#eaca2d", "#b4b4b4", "#9bd9e3", "#fdddd7")

theme_cpal <- function(base_size = 16, base_family = "sans") {
  colors <- deframe(ggthemes::ggthemes_data[["fivethirtyeight"]])
  (theme_foundation(base_size = base_size, base_family = base_family)
    + theme(
      line = element_line(colour = "#b4b4b4"),
      rect = element_rect(fill = "#ffffff",
                          linetype = 1, colour = NA),
      text = element_text(family = "Roboto", face = "bold", colour = "#6c6c6c"),
      axis.title = element_text(),
      axis.title.x = element_text(vjust = 2),
      axis.title.y = element_text(vjust = 2),
      axis.text = element_text(color = "#b4b4b4"),
      axis.ticks = element_blank(),
      #axis.ticks.length = unit(6, "pt"),
      axis.line = element_line(color = "#b4b4b4", size = 1.5, linetype = "solid"),
      legend.background = element_rect(),
      legend.position = "none",
      legend.direction = "horizontal",
      legend.box = "horizontal",
      panel.grid.major = element_line(colour = "#e1e1e1"),
      panel.grid.minor = element_blank(),
      plot.title = element_text(hjust = 0, size = rel(1.5), face = "bold"),
      plot.margin = unit(c(1, 2, 1, 1), "lines"),
      panel.border = element_rect(size=1, fill = NA),
      strip.background = element_rect()
    ))
}

#### Defining vgc and firearms #####
firearm <- c("Handgun", "Rifle","Firearm (Type Not Stated)", "Assault Weapon", "Unknown Type Gun", "Other/Unknown Gun", "Shotgun", "Other Gun", "Other Firearm")
vgc_type <- c("AGG ASSAULT - NFV", "MURDER & NONNEGLIGENT MANSLAUGHTER", "NEGLIGENT MANSLAUGHTER")

#### Importing Dallas Open Data portals and filtering into data frames #####
#dpdIncidents <- import("data/dpd_incidents_groupA.csv") %>%
dpdIncidents <- import("C:/Users/micha/Documents/GitHub/dpd_incidents_groupA.csv") %>%
  st_as_sf(coords = c(x = "x_coordinate", y = "y_coordinate"),
                                   crs = "ESRI:102738") %>%
  mutate(Date = as.Date(Date),
         Time = lubridate::hm(Time),
         Year = year(Date),
         Month = month(Date),
         Day = day(Date),
         crime_category = as.factor(nibrs_crime_category),
         crime = as.factor(nibrs_crime),
         Weekday = wday(Date),
         DateTime = format(paste(Date, Time), format="%Y-%m-%d %H:%M:%S"),
         hour = hour(Time),
         vgc_flag = ifelse(nibrs_crime %in% vgc_type & Firearm == 1, 1, 0)) %>%
  select(service_number_id, type_of_incident, type_location, type_of_property, beat:council_district, victim_type:victim_gender, hate_crime, weapon_used, gang_related_offense, zip_code:state, Date:vgc_flag) %>%
  st_transform(crs = 4269)

unique(dpdIncidents$crime)

currentmonth <- as.Date(paste0(year(today()), "-", month(max(dpdIncidents$Date)), "-01"))

last30 <- max(dpdIncidents$Date)-days(30)

vgc5year <- dpdIncidents %>%
  filter(vgc_flag == 1,
         Date >= max(Date)-years(5))

vgc12months <- dpdIncidents %>%
  filter(vgc_flag == 1,
         Date >= max(Date)-years(1))

vgc30days <- dpdIncidents %>%
  filter(vgc_flag == 1,
         Date >= max(Date)-days(30))

AggAs <- dpdIncidents %>%
  filter(crime == "AGG ASSAULT - NFV",
         Date >= last30)

RobBus <- dpdIncidents %>%
  filter(crime == "ROBBERY-BUSINESS",
         Date >= last30)

RobInd <- dpdIncidents %>%
  filter(crime == "ROBBERY-INDIVIDUAL",
         Date >= last30)

BurRes <- dpdIncidents %>%
  filter(crime == "BURGLARY-RESIDENCE",
         Date >= last30)

BurBus <- dpdIncidents %>%
  filter(crime == "BURGLARY-BUSINESS",
         Date >= last30)

dpdMini <- dpdIncidents %>%
  filter(crime %in% c("AGG ASSAULT - NFV", "ROBBERY-BUSINESS", "ROBBERY-INDIVIDUAL", "BURGLARY-RESIDENCE", "BURGLARY-BUSINESS", "MURDER & NONNEGLIGENT MANSLAUGHTER")) %>%
  filter(Date < currentmonth)

#### Import tenth mile grid of the City of Dallas #####
grid_incidents <- st_read("data/dallas_tenthmilegrid.geojson") %>%
  st_transform(crs = 4269) %>%
  mutate(vgc_5year = lengths(st_intersects(., vgc5year)),
         vgc_12months = lengths(st_intersects(., vgc12months)),
         vgc_5yearAvg = vgc_5year/5,
         vgc_perch = (vgc_12months-vgc_5yearAvg)/vgc_5yearAvg)

#### Import  Dallas boundaries #####
DallasBoundary <- st_read("data/dallas_simpleboundary.geojson") %>%
  st_transform(crs = 4269)

dpd_beats <- st_read("data/dpd_beats.geojson") %>%
  st_transform(crs = 4269)

dpd_divisions <- st_read("data/dpd_divisions.geojson") %>%
  st_transform(crs = 4269)

#### ACS Data #####
acs_var <- c(
  tot_pop = "B01003_001", #total population
  pop_u18 = "S0101_C01_022", #population under 18
  his_pop = "B03002_012", #hispanic population
  wh_pop = "B03002_003", #white population
  bl_pop = "B03002_004", #black population
  as_pop = "B03002_006", #asian population
#  oohh = "B25106_002", #owner-occupid households
#  rohh = "B25106_024", #renter-occupied households
#  thh = "B25106_001", #total households
  pop_bp = "S1701_C02_001", #population below poverty
  bp_u18 = "S1701_C02_002" #population under 18 below poverty
)

counties <- c("Dallas County",
              "Collin County",
              "Denton County")

tract_demographic_data <- get_acs(
  geography = "tract",
  variables = acs_var,
  year = 2019,
  state = "TX",
  county = counties,
  output = "wide",
  geometry = TRUE) %>%
  mutate(TractArea = as.numeric(st_area(.)))

tract_dallas <- tract_demographic_data[DallasBoundary, ] %>%
  mutate(vgc_count = lengths(st_intersects(., vgc12months)),
         vgc_rate = round(vgc_count/tot_popE*10000, digits = 1))
```

# Dallas Police Department Incident Report {-}
Using data from the Dallas Open Data portal this report is intended to summarize recent Dallas police department incidents. This report is intended to be updated once a month. An important caveat to the data presented within is the exclusion of all incidents involving juveniles. counts are subject to change over time. In order to keep this report manageable it will only include incidents classified as "Group A"

## Topline {-}

## Select Group A Incidents Overview {-}
The table below contains an overview of selected group A incidents for the most recent complete month (September). Data focuses on the count of incidents within the full month compared to the same month for the previous year and a five year average for the specified month. 
```{r, Incidents Table, echo = FALSE, message=FALSE, warning=FALSE}
incident_nibrs <- dpdMini %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month, crime) %>%
  summarize(count = n())

incident_vgc <- dpdIncidents %>%
  filter(vgc_flag == 1) %>%
  mutate(crime = "VIOLENT GUN CRIME") %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month, crime) %>%
  summarize(count = n())

incident_table <- full_join(incident_nibrs, incident_vgc) %>%
  filter(Year > 2016)

recent_month <- month(today())-month(1)

report_table <- incident_table %>%
  filter(Month == recent_month) %>%
  ungroup(.) %>%
  select(-Month) %>%
  pivot_wider(names_from = Year,
              names_prefix = "dpd_",
              values_from = count) %>%
  mutate(Year2Year = round((dpd_2021-dpd_2020)/dpd_2020, digits = 3),
         Avg5Year = (dpd_2017+dpd_2018+dpd_2019+dpd_2020+dpd_2021)/5,
         Diff5Year = round((dpd_2021-Avg5Year)/Avg5Year, digits = 3),
         crime = factor(crime, levels = c("MURDER & NONNEGLIGENT MANSLAUGHTER", "VIOLENT GUN CRIME", "AGG ASSAULT - NFV", "ROBBERY-BUSINESS", "ROBBERY-INDIVIDUAL", "BURGLARY-RESIDENCE", "BURGLARY-BUSINESS"))) %>%
  select(-(dpd_2017:dpd_2019))

# Render a bar chart with a label on the left
#####
bar_chart_pos_neg <- function(label, value, max_value = 1, height = "16px",
                              pos_fill = "#008097", neg_fill = "#ec008c") {
  neg_chart <- div(style = list(flex = "1 1 0"))
  pos_chart <- div(style = list(flex = "1 1 0"))
  width <- paste0(abs(value / max_value) * 100, "%")

  if (value < 0) {
    bar <- div(style = list(marginLeft = "8px", background = neg_fill, width = width, height = height))
    chart <- div(style = list(display = "flex", alignItems = "center", justifyContent = "flex-end"), label, bar)
    neg_chart <- tagAppendChild(neg_chart, chart)
  } else {
    bar <- div(style = list(marginRight = "8px", background = pos_fill, width = width, height = height))
    chart <- div(style = list(display = "flex", alignItems = "center"), bar, label)
    pos_chart <- tagAppendChild(pos_chart, chart)
  }

  div(style = list(display = "flex"), neg_chart, pos_chart)
}

#####
tbl_incidents <- reactable(report_table,
          compact = TRUE,
          class = "cpal-tbl",
          defaultSorted = c("crime"),
          columns = list(
            crime = colDef(
              name = "NIBRS",
              width = 200),
            dpd_2020 = colDef(
              name = "2020 Incidents"),
            dpd_2021 = colDef(
              name = "2021 Incidents"),
            Year2Year = colDef(
              name = "Per Change YtY",
              defaultSortOrder = "desc",
              cell = function(value) {
                label <- paste0(format(value*100, nsmall = 1), "%")
                bar_chart_pos_neg(label, value)
              },
              align = "center",
              minWidth = 200
              ),
            Avg5Year = colDef(
              name = "5 Year Avg",
              defaultSortOrder = "desc"),
            Diff5Year = colDef(
              name = "5 Year Avg Diff",
              defaultSortOrder = "desc",
              cell = function(value) {
                label <- paste0(format(value*100, nsmall = 1), "%")
                bar_chart_pos_neg(label, value)
              },
              align = "center",
              minWidth = 200
              )
            ),
            )

div(class = "cpal-table",
  div(class = "cpal-header",
    h2(class = "cpal-title", "Selected Group A Incidents for September 2021"),
    "Incidents compared to averages of incident data since 2016"
  ),
  tbl_incidents
)
```

## Line Graph of Incidents Over Time

Line graph below visualizes a three month average of selected group A incidents since 2017. 
```{r, Incident Line Graph, echo = FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=8}
#### Plot Time Series by Month #####
incident_table %>%
  mutate(YearMonth = as.Date(paste0(Year, "-", Month, "-01"))) %>%
  group_by(crime) %>%
  arrange(YearMonth) %>%
  mutate(Avg3Month = zoo::rollmean(count, k = 3, fill = NA)) %>%
  ungroup(.) %>%
  ggplot(
    aes(
      x = YearMonth,
      y = count,
      group = crime,
      color = crime
    )
  ) +
  geom_line(size=1, alpha = 0.9, stat = "identity") +
  scale_color_manual(values = CPAL.colors) +
  labs(
    title = "Group A Incidents Over Time",
    subtitle = "Between January 2017 - September 2021",
    x = "",
    y = "",
    color = 'VARIABLE'
  ) +
  theme_cpal() +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text=element_text(size=10))
```

## City of Dallas Selected Group A Incidents for September
This map displays the average percent change in violen gun crimes for the past 12 months in comparison to an average of incidents over the last 5 years. All incidents are aggregated to a tenth mile width grid.
```{r, fig.height=7, fig.width=7, echo=FALSE, message=FALSE, warning=FALSE}
cpal_style <- "https://api.mapbox.com/styles/v1/owencpal/ckecb71jp22ct19qc1id28jku/tiles/256/{z}/{x}/{y}@2x?access_token=pk.eyJ1Ijoib3dlbmNwYWwiLCJhIjoiY2tlYnR3emdxMGNhZzMwb2EzZWR4ajloNCJ9.P7Mujz8F3Rssq5-Q6dcvMw"

map_attr <- "© <a href='https://www.mapbox.com/map-feedback/'>Mapbox</a> Basemap © <a href='https://childpovertyactionlab.org/'>Child Poverty Action Lab</a>"

vgc_grid <- grid_incidents %>%
  filter(!is.na(vgc_perch))

minVal <- min(vgc_grid$vgc_perch, na.rm = TRUE)
maxVal <- max(vgc_grid$vgc_perch, na.rm = TRUE)
domain <- c(minVal,maxVal)

colorPal <- c(colorRampPalette(colors = c("#008097", "white"), space = "Lab")(abs(minVal)),
              colorRampPalette(colors = c("white", "#ec008c"), space = "Lab")(maxVal))

leaflet() %>%
  setView(lng = -96.7970, lat = 32.7767, zoom = 10) %>%
  addTiles(urlTemplate = cpal_style, attribution = map_attr) %>%
  addPolygons(data = vgc_grid,
              fillColor = ~get('colorBin')(colorPal,
                                           domain)(vgc_perch),
              label = ~paste0(round(vgc_perch*100, digits = 2), "%"),
              color = FALSE,
              fillOpacity = 0.7,
              opacity = 1,
              weight = 1,
              group = "Violent Gun Crimes")  %>%
    addPolygons(data = dpd_divisions,
              fill = FALSE,
              color = "#008097",
              opacity = 1,
              weight = 2) %>%
  addLegend(data = vgc_grid, 
            "topleft", 
            pal = colorBin(colorPal, domain = domain*100),
            values = ~domain,
            title = "VGC Percent Change (5 Year)",
            opacity = 0.9)
```
## Violent Gun Crime Rate for the past 12 months
This map displays the violent gun crime rate (per 10,000 residents) for the past 12 months by census tract. 
```{r, echo = FALSE, message=FALSE, warning=FALSE}
bins <- BAMMtools::getJenksBreaks(tract_dallas$vgc_rate, k = 5)
pal <- colorBin("BuPu", domain = tract_dallas$vgc_rate, bins = bins)

leaflet() %>%
  setView(lng = -96.7970, lat = 32.7767, zoom = 10) %>%
  addTiles(urlTemplate = cpal_style, attribution = map_attr) %>%
  addPolygons(data = tract_dallas,
              fillColor = ~pal(vgc_rate),
              color = FALSE,
              fillOpacity = 0.7,
              opacity = 1,
              weight = 1,
              label = ~paste("VGC Rate:", vgc_rate)) %>%
  addPolygons(data = dpd_divisions,
              fill = FALSE,
              color = "#008097",
              opacity = 1,
              weight = 2) %>%
  addLegend(data = tract_dallas, "topleft", pal = pal, values = ~vgc_rate,
            title = "Violent Gun Crime Rate",
            opacity = 1)
```
```{r, echo = FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=8}
dpdMini %>%
  st_drop_geometry(.) %>%
  filter(Date >= as.Date("2021-09-01") & Date < as.Date("2021-10-01")) %>%  
  group_by(type_location) %>%
  summarize(victim_count = n()) %>%
  arrange(desc(victim_count)) %>%
  mutate(perc = victim_count/sum(victim_count)) %>%
  slice_head(., n = 7) %>%
  ggplot(
    aes(
      x = type_location,
      y = victim_count,
      #      group = crime_category,
      #      color = victim_race,
      fill = type_location,
    )
  ) +
  geom_bar(size=1, alpha = 1, stat = "identity") +
  #  scale_color_manual(values = CPAL.color.eight) +
  scale_fill_manual(values = CPAL.colors) +
  geom_text(aes(label = scales::percent(perc, accuracy = 0.1)),
            vjust = 2, color = "#FFFFFF", fontface = "bold", size = 7) +
  #  scale_size_manual(values = 3) +
  #  theme(legend.position = "none") +
  labs(
    title = "Violent Gun Crime by Premise",
    subtitle = "For the month of September 2021",
    x = "",
    y = "",
    color = 'VARIABLE'
  ) +
  theme_cpal() +
  theme(axis.text.x=element_text(angle=30, hjust=0.7, vjust = 0.7))

```

```{r, echo = FALSE, message=FALSE, warning=FALSE, fig.width=10,fig.height=8}
plot.demo <- as_tibble(cbind(victim_race = c("American Indian or Alaska Native", "Asian","Black", "Hispanic or Latino", "White"),
                             type = c("City", "City", "City", "City", "City"),
                             per = c(0.014, 0.0336, 0.2395, 0.4180, 0.2897))) %>%
  #per = c(0, 0, 0.56, 0.32, 0.02))) %>% #SC Quadrant
  mutate(per = as.double(per))

plot.vgc <- dpdMini %>%
  st_drop_geometry(.) %>%
  filter(Date >= as.Date("2021-09-01") & Date < as.Date("2021-10-01")) %>%
  drop_na(victim_race) %>%
  group_by(victim_race) %>%
  summarize(victim_count = n()) %>%
  mutate(type = "Incident Victims",
         per = victim_count/sum(victim_count)) %>% #EDIT FOR OTHER GEOGRAPHIES
  filter(victim_race != "Unknown",
         victim_race != "NH",
         victim_race != "Native Hawaiian/Pacific Islander",
         #victim_race != "American Indian or Alaska Native",
         victim_race != "Middle Eastern",
         victim_race != "")

plot.race <- full_join(plot.demo, plot.vgc) %>%
  mutate(type = as.factor(type)) %>%
  filter(per != 0)

plot.race %>%
  ggplot(
    aes(
      x = victim_race,
      y = per,
      fill = type
    )
  ) +
  geom_bar(size=1, alpha = 1, stat = 'identity', position = 'dodge') +
  scale_y_continuous(labels = scales::percent, limits = c(0,0.6)) +
  scale_fill_manual(values = c("#008097", "#ec008c", "#eaca2d", "#b4b4b4", "#9bd9e3", "#fdddd7", "#9191E9")
  ) +
  theme_cpal() +
  theme(legend.position = "bottom") +
  labs(
    title = "Incident Victims by selected incident types",
    subtitle = "In comparison to city demographics (%).",
    x = "",
    y = "",
    color = ""
  ) +
  theme(legend.title=element_blank())

```




## Select Group A Incidents by Division

```{r, echo = FALSE, message=FALSE, warning=FALSE}
#names(dpdMini)
incident_nibrs_div <- dpdMini %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month, division, crime) %>%
  summarize(count = n())

incident_vgc_div <- dpdIncidents %>%
  filter(vgc_flag == 1) %>%
  mutate(crime = "VIOLENT GUN CRIME") %>%
  st_drop_geometry(.) %>%
  group_by(Year, Month, division, crime) %>%
  summarize(count = n())

incident_table_div <- full_join(incident_nibrs_div, incident_vgc_div) %>%
  filter(Year > 2016)

recent_month <- month(today()-days(14))

report_table_div <- incident_table_div %>%
  filter(Month == recent_month) %>%
  ungroup(.) %>%
  select(-Month) %>%
  mutate(division = str_to_upper(division)) %>%
  group_by(Year, division, crime) %>%
  summarize(count = sum(count)) %>%
  ungroup(.) %>%
  pivot_wider(names_from = Year,
              names_prefix = "dpd_",
              values_from = count) %>%
  mutate(Year2Year = paste0(round((dpd_2021-dpd_2020)/dpd_2020*100, digits = 1), "%"),
         Avg5Year = (dpd_2017+dpd_2018+dpd_2019+dpd_2020+dpd_2021)/5,
         Diff5Year = paste0(round((dpd_2021-Avg5Year)/Avg5Year*100, digits = 1), "%")) %>%
  select(-(dpd_2017:dpd_2019))

reactable(report_table_div,
          columns = list(
            division = colDef(
              name = "Division Incident"),
            division = colDef(
              name = "NIBRS Incident"),
            dpd_2020 = colDef(
              name = "2020 Incidents"),
            dpd_2021 = colDef(
              name = "2021 Incidents"),
            Year2Year = colDef(
              name = "Percent Change Year to Year"),
            Avg5Year = colDef(
              name = "5 Year Average"),
            Diff5Year = colDef(
              name = "5 Year Average Difference")
            ),
          theme = reactableTheme(
            headerStyle = list(
              "&:hover[aria-sort]" = list(background = "hsl(0, 0%, 96%)"),
              "&[aria-sort='ascending'], &[aria-sort='descending']" = list(background = "hsl(0, 0%, 96%)"),
              borderColor = "#555"
              )
            )
          )
```

